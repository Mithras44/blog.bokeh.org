<!doctype html>
<meta charset="utf-8">
<head>

<link rel="stylesheet" href="../../../../../static/normalize.css">
<link rel="stylesheet" href="../../../../../static/skeleton.css">
<link rel="stylesheet" href="../../../../../static/style.css">
<link rel="stylesheet" href="../../../../../static/gen/styles.css">
<link rel="stylesheet" href="../../../../../static/custom.css">
<link rel="stylesheet" href="../../../../../static/pygments.css">

<!-- Mobile Specific Metas
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- FONT
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

<title>Enjoying the bokeh.models API | Bokeh Org</title>

</head>
<body>
    <div class="navbar-spacer"></div>
    <nav class="navbar">
      <div class="container">
        <ul class="navbar-list">
            <li class="navbar-item"><a class="navbar-link" href="/">Home</a></li>
            <li class="navbar-item"><a class="navbar-link" href="http://bokeh.pydata.org/en/latest">Documentation</a></li>
            <li class="navbar-item"><a class="navbar-link" href="/blog">Blog</a></li>
        </ul>
      </div>
    </nav>

    <div class="body-wrapper">
      
  <div class="blog-post">
    
  
    
  <div class="container">
    <div class="row">
      <div class="eleven columns">
        
      <div class="meta-bar">
        <h1>Enjoying the bokeh.models API</h1>
        <p class="meta">
          by
          
            <a href="https://twitter.com/canavandl">Luke Canavan</a>
          
          on Wednesday, July 5, 2017
        </p>
      </div>
    
      </div>
    </div>
  </div>

  
  
    
      
  <div class="container">
    <div class="row">
      <div class="eleven columns">
        <div class="text-block text-block-default">
  <hr>
<h2>Prior Art</h2>
<p>I was inspired to write a cookbook-style bokeh educational guide after reading
Tom Auspurger's recent <a href="https://tomaugspurger.github.io/modern-1.html">Modern Pandas</a>
series. As a Bokeh developer who has written a lot of Bokeh visualizations,
I've developed a some personal opinions on best practices for using Bokeh. A
great resource for following along is the
<a href="http://bokeh.pydata.org/en/latest/docs/user_guide.html">User Guide</a>
section of the Bokeh documentation.</p>
<h2>Introduction</h2>
<p>Let's define some Bokeh terminology before diving into things. In Bokeh, Models
represent all the parts of your visualization: plots, data sources,
axes, tools, etc. They are classes that have some defined properties
(i.e. <code>Plot</code> models have a <code>plot_height</code> and <code>plot_width</code>), as well as
some associated event handling (i.e. changing the
<code>Plot.background_fill_color</code> property will cause the plot to re-render and
update the background_fill_color).</p>
<p>Models Reference: <a href="http://bokeh.pydata.org/en/latest/docs/reference/models.html">http://bokeh.pydata.org/en/latest/docs/reference/models.html</a></p>
<p>Glyphs are a subset of Models and represent Bokeh's plotting primitives-
the Lines, Circles and Rects that compose visualizations. You could think
of them as the equivalent to D3's elements.</p>
<p>Glyphs Reference: <a href="http://bokeh.pydata.org/en/latest/docs/reference/models/glyphs.html">http://bokeh.pydata.org/en/latest/docs/reference/models/glyphs.html</a></p>
<p>Bokeh has two main API levels for assemble these Models and Glyphs into
full-fledged visualization:</p>
<ul>
<li><code>bokeh.plotting</code> for mid-level, with reasonable defaults for conciseness</li>
<li><code>bokeh.models</code> for low-level, very explicit development</li>
</ul>
<p>Additionally, some libraries built on top of Bokeh offer an even higher
level of abstraction such as <a href="http://holoviews.org/">HoloViews</a>.</p>
<p>There are several valid Bokeh-development patterns, but I find the low-level,
primitives-based bokeh.models API to be ideal for developing custom, bespoke
visualizations. Under the hood, Bokeh generates a JSON blob called a
"scenegraph" that describes the visualization (a "Document" in Bokeh) and
is consumed by the BokehJS client library in order to render an output.
You can view this scenegraph via the <code>Document.to_json</code> method, thought it's
generally not readable by humans.</p>
<p>It's helpful to know that all Bokeh visualizations boil down to a collection
of models and attributes. In order to build up a scenegraph, you just have to
build up a collection of models. There's not any magic beyond that.</p>
<p>Please note, I haven't used Bokeh much in an exploratory
manner, so I don't know how well the below workflow fits. Usually I have an
idea of the shape of my data and what my intended visualization looks like.</p>
<hr>
<h2>Using the <code>bokeh.models.plots.Plot</code> object</h2>
<p>The basis of using the low-level <code>bokeh.models</code> API is building visualizations
using the <code>`Plot</code> Model. A <code>Plot</code> object is the foundation onto which any
Bokeh visualization is composed - it holds all of axes, grids, glyphs and
toolbar tools. Additionally, there are a few Plot-specific properties like
height, width and background color. A good reference for understanding these
is the <code>Plot</code>
<a href="http://bokeh.pydata.org/en/latest/docs/reference/models/plots.html#bokeh.models.plots.Plot">documentation</a>.</p>
<p>You only have to specify a <code>Plot</code> object's <code>x_range</code> and <code>y_range</code>
attributes for it to be renderable. Creating a range-only Plot will yield an
empty rectangle when passed to the <code>bokeh.io.show</code> method, which is exactly
what we expect. It's an empty canvas without any axes, glyphs or tools!</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bokeh.models</span> <span class="kn">import</span> <span class="n">Plot</span><span class="p">,</span> <span class="n">Range1d</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span><span class="n">x_range</span><span class="o">=</span><span class="n">Range1d</span><span class="p">(),</span> <span class="n">y_range</span><span class="o">=</span><span class="n">Range1d</span><span class="p">(),</span> <span class="n">plot_height</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
<div>
  <script
      src="blank_plot.js"
      id="e63c762d-2c1b-4167-8711-ac61da385d54"
      data-bokeh-model-id="37768dfd-9456-416e-9830-003e03dbf404"
      data-bokeh-doc-id="c659cace-3466-420f-941e-e3a889e3164f"
  ></script></div><p>This is exciting stuff!</p>
<h3>Defining Ranges: Using a Range1d vs FactorRange vs DataRange1d</h3>
<p>There are three range types and it's helpful to pick the right one. You use the
<code>Range1d</code> Model when you want to set the start and end values of your range,
regardless of what data is being plotted. For example, I would use a Range1d
when I want a range to span from 0 - 100%, even if my data's range is from 12 - 94%.</p>
<div class="highlight"><pre><span></span><span class="nb">range</span> <span class="o">=</span> <span class="n">Range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
<p>The <code>FactorRange</code> Model is similar to the Range1d model, except that handles
categorical values instead of continuous ones. An example situation to use
a FactorRange is when plotting values by months of the year.</p>
<div class="highlight"><pre><span></span><span class="nb">range</span> <span class="o">=</span> <span class="n">FactorRange</span><span class="p">(</span><span class="n">factors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span> <span class="s2">&quot;Feb&quot;</span><span class="p">,</span> <span class="s2">&quot;Mar&quot;</span><span class="p">,</span> <span class="s2">&quot;Apr&quot;</span><span class="p">,</span> <span class="s2">&quot;May&quot;</span><span class="p">,</span> <span class="s2">&quot;Jun&quot;</span><span class="p">])</span>
</pre></div>
<p>You use a <code>DataRange1d</code> Model when you want the range to reflect the extent
of your plotted data. For example, Dask.distributed uses Bokeh for its
diagnostic web interface <a href="https://distributed.readthedocs.io/en/latest/web.html">link</a>.
The interface takes advantage of a several DataRange1d models to plot the
progress of computation tasks and CPU/memory usage over time. The DataRange1d
inspects the min and max of the plotted values and automatically adjusts the
visible range accordingly.</p>
<div class="highlight"><pre><span></span><span class="nb">range</span> <span class="o">=</span> <span class="n">DataRange1d</span><span class="p">()</span>
</pre></div>
<p>One new requirement in Bokeh 0.12.6 is that range models correspond with an
appropriate <code>Scale</code> Model (which maps between screen and data space) on
the same dimension. If you have a misconfigured Range and Scale pair, you'll
raise a validation error.</p>
<hr>
<h2>Additive development, not subtractive or mutative</h2>
<p>In general, I prefer to develop Bokeh visualizations in an additive way,
where each element or interaction is explicitly inserted. The result is usually
more verbose, but I feel the code is easier to write and read later.</p>
<p>I think it's best to show a counter-example to demonstrate the model mutation
and deletion tangle I'm hoping to avoid. The core of the bokeh.plotting API is
the <code>figure</code> method, which creates a subclassed instance of Plot with defaults
related to ranges, axes, grids, tools, etc.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bokeh.plotting</span> <span class="kn">import</span> <span class="n">figure</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">figure</span><span class="p">()</span>
</pre></div>
<p>These defaults are very reasonable and many can be modified via arguments to
the <code>figure</code> method. In my experience, however, they often include models I
need to remove or modify and my code starts to look like this:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bokeh.plotting</span> <span class="kn">import</span> <span class="n">figure</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">figure</span><span class="p">()</span>

<span class="c1"># hide the x and y grids</span>
<span class="n">plot</span><span class="o">.</span><span class="n">xgrid</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">plot</span><span class="o">.</span><span class="n">ygrid</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># change x axis defaults</span>
<span class="n">plot</span><span class="o">.</span><span class="n">xaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">BasicTicker</span><span class="p">(</span><span class="n">num_desired_ticks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plot</span><span class="o">.</span><span class="n">xaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">NumericalTickFormatter</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s2">&quot;0b&quot;</span><span class="p">)</span>
<span class="n">plot</span><span class="o">.</span><span class="n">xaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min_tick_line_width</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">plot</span><span class="o">.</span><span class="n">xaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">major_tick_line_width</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
<p>At this level of customization, it's easier to explicitly set the property
values in the Models' <code>__init__</code> methods and not have created unwanted Models
in the first place. The code below generated the same output as above, but reads
more cleanly.</p>
<div class="highlight"><pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">()</span>

<span class="n">x_axis</span> <span class="o">=</span> <span class="n">LinearAxis</span><span class="p">(</span>
  <span class="n">formatter</span><span class="o">=</span><span class="n">NumericalTickFormatter</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s2">&quot;0b&quot;</span><span class="p">),</span>
  <span class="n">ticker</span><span class="o">=</span><span class="n">BasicTicker</span><span class="p">(</span><span class="n">num_desired_ticks</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
  <span class="n">min_tick_line_width</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
  <span class="n">major_tick_line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">y_axis</span> <span class="o">=</span> <span class="n">LinearAxis</span><span class="p">()</span>

<span class="n">plot</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="s1">&#39;below&#39;</span><span class="p">)</span>
<span class="n">plot</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">y_axis</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
<h2>Tools</h2>
<p>I generally only include a single tool with non-default attributes in finalized
visualizations, whether it's a HoverTool with a custom tooltips or a TapTool
that initiates some sort of custom interaction. Therefore, instead of selecting
and mutating a tool that is added by default in via the <code>figure</code> method, it's
cleaner to explicitly create and add tools.</p>
<div class="highlight"><pre><span></span><span class="c1"># Don&#39;t do this</span>
<span class="n">hover</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">select_one</span><span class="p">(</span><span class="n">HoverTool</span><span class="p">)</span>
<span class="n">hover</span><span class="o">.</span><span class="n">tooltips</span> <span class="o">=</span> <span class="n">my_custom_tooltips</span>
<span class="n">hover</span><span class="o">.</span><span class="n">line_policy</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span>
<span class="n">pan</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">select_one</span><span class="p">(</span><span class="n">PanTool</span><span class="p">)</span>
<span class="n">pan</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>

<span class="c1"># Do this instead</span>
<span class="n">hover_tool</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span><span class="n">tooltips</span><span class="o">=</span><span class="n">my_custom_tooltips</span><span class="p">,</span> <span class="n">line_policy</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
<span class="n">pan_tool</span> <span class="o">=</span> <span class="n">PanTool</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plot</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">hover_tool</span><span class="p">,</span> <span class="n">pan_tool</span><span class="p">)</span>
</pre></div>
<p>The <code>figure</code> method also supports adding tools like this or via the
<strong>init</strong> method (i.e. ``figure(tools=[hover_tool, pan_tool])), so it may be a
good habit to build.</p>
<h2>Glyphs</h2>
<p>Glyphs are added via the <code>Plot.add_glyph</code> method, which requires creating
a ColumnDataSource instead of optionally creating one (or implicitly having
it happen internally) like the convenience glyphs methods of <code>Figure</code>.</p>
<p>The string keyword argument values are matched up against equally-named columns
in the ColumnDataSource while single values are broadcast across all of the
glyphs.</p>
<h2>Adding glyphs</h2>
<div class="highlight"><pre><span></span><span class="n">source</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
  <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">))</span>

<span class="n">plot</span><span class="o">.</span><span class="n">add_glyph</span><span class="p">(</span>
  <span class="n">source</span><span class="p">,</span>
  <span class="n">Rect</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">))</span>
</pre></div>
<h2>Wrap up</h2>
<p>Using the bokeh.models interface trades a little extra typing for a simpler
incremental approach to building interactive visualizations. Refactoring code
developed in this way is easier because it's obvious where elements of the
visualization are created and added. All-in-all, I think it's the way to go.</p>

</div>
      </div>
    </div>
  </div>

    
  


    
    
    
    <div class="container">
      <div class="row">
        <div class="eight columns">
        
          <div class="nav-prev">
            <a href="../../../../../blog/2017/6/29/simple_bokeh_server/">Previous: Programmatic Bokeh Servers</a>
          </div>
        
        
          <div class="nav-next">
            <a href="../../../../../blog/2017/7/24/styling-bokeh/">Next: Styling Bokeh Visualizations</a>
          </div>
        
        </div>
      </div>
    </div>
  </div>

    </div>

    
    <div class="bottomsummary">
      <div class="container">
      </div>
    </div>
    

    
    <footer>
      <div class="container">
        <div class="row">
          <div class="four columns icon-bar">
            <a href="https://github.com/bokeh/bokeh/" title="Bokeh on GitHub"
              ><i class="fa fa-github"></i></a>
            <a href="https://github.com/bokeh/bokeh/issues/" title="Report Issues for Bokeh"
              ><i class="fa fa-bug"></i></a>
            <a href="https://twitter.com/BokehPlots" title="Find Bokeh on Twitter"
              ><i class="fa fa-twitter"></i></a>
            <a href="https://gitter.im/bokeh/bokeh" title="Chat on Gitter"
              ><i class="fa fa-comment"></i></a>
            <a href="https://github.com/bokeh/bokeh.github.io/tree/source/content/blog/idiomatic_bokeh/contents.lr" title="View source for this page"><i class="fa fa-code"></i></a>
          </div>
        </div>
      </div>
    </footer>
    

<!-- JS
================================================== -->
<script src="https://code.jquery.com/jquery-1.7.1.min.js"></script>

<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27761864-7', 'pydata.org');
  ga('send', 'pageview');
</script>

</body>
